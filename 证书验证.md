# 证书验证

> 规则：在SSL/TLS、IPSEC等使用数字证书实现身份认证的场景，必须验证对端证书的有效性，必选验证项包括对端证书是否由受信根CA签发、是否在有效期内。

证书校验 主要分为双向认证（客户端校验服务端证书，服务端校验客户端证书）和单向认证（客户端校验服务端证书）

### 不校验证书

自己实现TrustManager，里面checkClientTrusted和checkServerTrusted方法为空即可。
一般情况下，用参数控制，如果配置的为信任所有证书，则可以使用下面的代码

第一种

```java
            TrustManager[] trustManagers =
                    new TrustManager[]{
                            new X509TrustManager() {
                                @Override
                                public void checkClientTrusted(X509Certificate[] x509Certificates, String s)
                                        throws CertificateException {
                                    // 方法不做任何实现 
                                }

                                @Override
                                public void checkServerTrusted(X509Certificate[] x509Certificates, String s)
                                        throws CertificateException {
                                    // 方法不做任何实现
                                }

                                @Override
                                public X509Certificate[] getAcceptedIssuers() {
                                    return new X509Certificate[0];
                                }
                            }
                    };
            SSLContext sslContext = SSLContext.getInstance("SSL", "SunJSSE");
            sslContext.init(null, tm, new java.security.SecureRandom());
```

第二种

```java

public class CustomSSLContextBuilder {
    public CustomSSLContextBuilder() {
    }

    public SSLContext build() throws KeyStoreException, NoSuchAlgorithmException, KeyManagementException {
        TrustStrategy acceptingTrustStrategy = (chain, authType) -> {
          // 方法不做任何校验，直接返回true
            return true;
        };
        SSLContext sslContext = SSLContexts.custom().loadTrustMaterial((KeyStore)null, acceptingTrustStrategy).build();
        return sslContext;
    }
}

// 调用点
SSLContext sslContext = new CBCSSLContextBuilder().build();

```

### 单向认证

> 单向认证满足99%场景，单向认证的场景就是校验服务端证书，那么客户端就必须要导入服务端证书到客户端的信任证书链中，单向认证需要的文件：truststore.jks，这个文件需要包含所有需要通信的服务端的证书。

```java
private static SSLContext buildSSLContext(String certPath, String certPassword)
            throws IOException, NoSuchAlgorithmException, KeyStoreException, CertificateException,
                    KeyManagementException {
        SSLContext sslContext = SSLContext.getInstance("TLSv1.2");

        try (InputStream inputStream = UsFileUtils.getFileInputStream(certPath)) {
            KeyStore keyStore = KeyStore.getInstance("JKS");
            keyStore.load(inputStream, certPassword.toCharArray());
            TrustManagerFactory tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());
            tmf.init(keyStore);

            sslContext.init(null, tmf.getTrustManagers(), null);
        }

        return sslContext;
    }
```



